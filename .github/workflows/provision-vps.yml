name: Provision VPS
# passwordless sudo + key-only SSH configured on VPS

on:
  push:
    branches:
      - terraform
    paths:
      - 'packer/**'
      - '.github/workflows/provision-vps.yml'
  workflow_dispatch:

jobs:
  provision:
    name: Provision VPS via Packer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: latest

      - name: Initialize Packer
        run: |
          cd packer
          packer init .

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H avirus.xyz >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Derive SSH public key
        id: pubkey
        run: |
          PUBKEY=$(ssh-keygen -y -f ~/.ssh/id_rsa)
          echo "ssh_public_key=${PUBKEY}" >> $GITHUB_OUTPUT

      - name: Provision VPS
        run: |
          cd packer
          packer build \
            -only='hostinger-vps-provision.*' \
            -var "ssh_public_key=${{ steps.pubkey.outputs.ssh_public_key }}" \
            .
        timeout-minutes: 30

  verify:
    name: Verify Provisioning
    runs-on: ubuntu-latest
    needs: provision
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H avirus.xyz >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Verify tools installed
        run: |
          ssh -o StrictHostKeyChecking=no \
            aviral@avirus.xyz \
            "which zsh tmux nvim git stow && echo 'All tools verified'"

      - name: Verify shell
        run: |
          SHELL=$(ssh -o StrictHostKeyChecking=no \
            aviral@avirus.xyz \
            "getent passwd aviral | cut -d: -f7")
          echo "User shell: ${SHELL}"
          case "${SHELL}" in
            */zsh) echo "Shell correctly set to zsh (${SHELL})" ;;
            *) echo "WARNING: Shell is ${SHELL}, expected zsh"; exit 1 ;;
          esac
