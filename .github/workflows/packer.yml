name: Packer

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_base:
        description: 'Rebuild the base AMI'
        type: boolean
        default: false

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

permissions:
  contents: read
  id-token: write

jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      base_changed: ${{ steps.changes.outputs.base }}
      packer_changed: ${{ steps.changes.outputs.packer }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for packer changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "packer=true" >> "$GITHUB_OUTPUT"
            echo "base=${{ inputs.build_base }}" >> "$GITHUB_OUTPUT"
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            if echo "$CHANGED_FILES" | grep -qE '^ops/packer/'; then
              echo "packer=true" >> "$GITHUB_OUTPUT"
            else
              echo "packer=false" >> "$GITHUB_OUTPUT"
            fi
            BASE_PATTERNS="ops/packer/base.pkr.hcl|ops/packer/variables.pkr.hcl|ops/packer/scripts/install_system_packages.sh|ops/packer/scripts/install_rust.sh|ops/packer/scripts/install_cli_tools.sh"
            if echo "$CHANGED_FILES" | grep -qE "$BASE_PATTERNS"; then
              echo "base=true" >> "$GITHUB_OUTPUT"
            else
              echo "base=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  validate-templates:
    name: Validate Templates
    needs: detect-changes
    if: needs.detect-changes.outputs.packer_changed == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ops/packer
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: Packer Init
        run: packer init .

      - name: Packer Validate
        run: packer validate .

  build-base:
    name: Build Base AMI
    needs: [detect-changes, validate-templates]
    if: needs.detect-changes.outputs.base_changed == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ops/packer
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: Packer Init
        run: packer init .

      - name: Packer Build Base
        run: packer build -only=amazon-ebs.base -var "branch=$BRANCH_NAME" .

  build-devbox:
    name: Build Devbox AMI
    needs: [detect-changes, validate-templates, build-base]
    if: >-
      always() &&
      needs.detect-changes.outputs.packer_changed == 'true' &&
      needs.validate-templates.result == 'success' &&
      (needs.build-base.result == 'success' || needs.build-base.result == 'skipped')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ops/packer
    outputs:
      ami_id: ${{ steps.build.outputs.ami_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: Packer Init
        run: packer init .

      - name: Packer Build Devbox
        id: build
        run: |
          packer build -only=amazon-ebs.devbox -machine-readable -var "branch=$BRANCH_NAME" . 2>&1 | tee build.log
          echo "=== Searching for AMI ID in build.log ==="
          grep 'artifact' build.log || echo "No artifact lines found"
          AMI_ID=$(grep -E ',artifact,0,id,' build.log | grep -oE 'ami-[a-f0-9]+')
          echo "Extracted AMI_ID: $AMI_ID"
          if [ -z "$AMI_ID" ]; then
            echo "ERROR: Failed to extract AMI ID from build log"
            exit 1
          fi
          echo "ami_id=$AMI_ID" >> "$GITHUB_OUTPUT"

  validate:
    name: Validate AMI
    needs: build-devbox
    if: needs.build-devbox.outputs.ami_id != ''
    runs-on: ubuntu-latest

    env:
      TF_VAR_hostinger_api_token: ${{ secrets.HOSTINGER_API_TOKEN }}
      TF_VAR_github_token: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Generate SSH key pair
        run: |
          ssh-keygen -t ed25519 -f /tmp/devbox-key -N ""
          echo "SSH_PUBLIC_KEY=$(cat /tmp/devbox-key.pub)" >> "$GITHUB_ENV"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Launch EC2 instance
        working-directory: ops/terraform
        run: |
          AMI_ID="${{ needs.build-devbox.outputs.ami_id }}"
          echo "Validating AMI: $AMI_ID"
          terraform init
          terraform apply -auto-approve \
            -var="devbox_enabled=true" \
            -var="ssh_public_key=$SSH_PUBLIC_KEY" \
            -var="devbox_ami_override=$AMI_ID"
          echo "INSTANCE_IP=$(terraform output -raw devbox_public_ip)" >> "$GITHUB_ENV"

      - name: Wait for instance to be ready
        run: |
          echo "Waiting for SSH on $INSTANCE_IP..."
          for i in $(seq 1 30); do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i /tmp/devbox-key "ubuntu@$INSTANCE_IP" true 2>/dev/null; then
              echo "SSH is ready"
              exit 0
            fi
            echo "Attempt $i/30 - waiting 10s..."
            sleep 10
          done
          echo "Timed out waiting for SSH"
          exit 1

      - name: Run validation
        run: |
          scp -o StrictHostKeyChecking=no -i /tmp/devbox-key \
            ops/packer/scripts/validate_tools.sh "ubuntu@$INSTANCE_IP:/tmp/validate_tools.sh"
          ssh -o StrictHostKeyChecking=no -i /tmp/devbox-key "ubuntu@$INSTANCE_IP" \
            "chmod +x /tmp/validate_tools.sh && /tmp/validate_tools.sh"

      - name: Tear down EC2 instance
        if: always()
        working-directory: ops/terraform
        run: |
          terraform apply -auto-approve \
            -var="devbox_enabled=false" \
            -var="ssh_public_key=$SSH_PUBLIC_KEY" \
            -var="devbox_ami_override=${{ needs.build-devbox.outputs.ami_id }}"

      - name: Cleanup SSH key
        if: always()
        run: rm -f /tmp/devbox-key /tmp/devbox-key.pub

  cleanup-amis:
    name: Cleanup Old AMIs
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Cleanup old base AMIs
        run: |
          echo "Querying base AMIs tagged branch=main..."
          AMIS=$(aws ec2 describe-images \
            --owners self \
            --filters "Name=name,Values=devbox-base-*" "Name=tag:built-by,Values=packer" "Name=tag:branch,Values=main" \
            --query 'Images | sort_by(@, &CreationDate) | reverse(@)' \
            --output json)

          TOTAL=$(echo "$AMIS" | jq 'length')
          echo "Found $TOTAL base AMI(s) tagged branch=main"

          if [ "$TOTAL" -le 3 ]; then
            echo "Nothing to clean up (keeping 3)."
            exit 0
          fi

          echo "$AMIS" | jq -r '.[3:] | .[] | .ImageId' | while read -r AMI_ID; do
            echo "--- Deregistering $AMI_ID ---"
            SNAPSHOTS=$(aws ec2 describe-images --image-ids "$AMI_ID" \
              --query 'Images[0].BlockDeviceMappings[*].Ebs.SnapshotId' --output text)
            if aws ec2 deregister-image --image-id "$AMI_ID"; then
              echo "Deregistered $AMI_ID"
              for SNAP in $SNAPSHOTS; do
                if [ "$SNAP" != "None" ]; then
                  aws ec2 delete-snapshot --snapshot-id "$SNAP" && echo "Deleted snapshot $SNAP" || echo "WARNING: Failed to delete snapshot $SNAP"
                fi
              done
            else
              echo "WARNING: Failed to deregister $AMI_ID"
            fi
          done

      - name: Cleanup old devbox AMIs
        run: |
          echo "Querying devbox AMIs tagged branch=main..."
          AMIS=$(aws ec2 describe-images \
            --owners self \
            --filters "Name=name,Values=dotfiles-devbox-*" "Name=tag:built-by,Values=packer" "Name=tag:branch,Values=main" \
            --query 'Images | sort_by(@, &CreationDate) | reverse(@)' \
            --output json)

          TOTAL=$(echo "$AMIS" | jq 'length')
          echo "Found $TOTAL devbox AMI(s) tagged branch=main"

          if [ "$TOTAL" -le 3 ]; then
            echo "Nothing to clean up (keeping 3)."
            exit 0
          fi

          echo "$AMIS" | jq -r '.[3:] | .[] | .ImageId' | while read -r AMI_ID; do
            echo "--- Deregistering $AMI_ID ---"
            SNAPSHOTS=$(aws ec2 describe-images --image-ids "$AMI_ID" \
              --query 'Images[0].BlockDeviceMappings[*].Ebs.SnapshotId' --output text)
            if aws ec2 deregister-image --image-id "$AMI_ID"; then
              echo "Deregistered $AMI_ID"
              for SNAP in $SNAPSHOTS; do
                if [ "$SNAP" != "None" ]; then
                  aws ec2 delete-snapshot --snapshot-id "$SNAP" && echo "Deleted snapshot $SNAP" || echo "WARNING: Failed to delete snapshot $SNAP"
                fi
              done
            else
              echo "WARNING: Failed to deregister $AMI_ID"
            fi
          done

  packer-result:
    name: Packer Result
    if: always()
    needs: [detect-changes, validate-templates, build-base, build-devbox, validate, cleanup-amis]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.detect-changes.outputs.packer_changed }}" != "true" ]; then
            echo "No packer changes detected, skipping."
            exit 0
          fi
          if [ "${{ needs.validate-templates.result }}" = "failure" ]; then
            echo "Template validation failed."
            exit 1
          fi
          if [ "${{ needs.build-devbox.result }}" = "failure" ]; then
            echo "Devbox AMI build failed."
            exit 1
          fi
          if [ "${{ needs.validate.result }}" != "success" ]; then
            echo "AMI validation did not pass (result: ${{ needs.validate.result }})."
            exit 1
          fi
          if [ "${{ needs.cleanup-amis.result }}" = "failure" ]; then
            echo "WARNING: AMI cleanup failed, but build and validation succeeded."
          fi
          echo "All packer checks passed."