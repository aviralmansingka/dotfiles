name: Build and Publish Docker Images

on:
  push:
    branches: [ "develop", "main" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "develop", "main" ]
  schedule:
    # Rebuild images weekly on Sundays at 6 AM UTC
    - cron: '0 6 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu, centos, alpine]
        include:
          - platform: ubuntu
            dockerfile: tests/docker/ubuntu.Dockerfile
            description: "Ubuntu-based development environment with dotfiles tools"
            base_image: "ubuntu:22.04"
          - platform: centos
            dockerfile: tests/docker/centos.Dockerfile
            description: "CentOS Stream 9 development environment with dotfiles tools"
            base_image: "quay.io/centos/centos:stream9"
          - platform: alpine
            dockerfile: tests/docker/alpine.Dockerfile
            description: "Alpine Linux lightweight development environment with dotfiles tools"
            base_image: "alpine:latest"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.platform }}
        flavor: |
          latest=auto
          prefix=
          suffix=
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
        labels: |
          org.opencontainers.image.title=Dotfiles ${{ matrix.platform }} Environment
          org.opencontainers.image.description=${{ matrix.description }}
          org.opencontainers.image.vendor=Aviral Mansingka
          org.opencontainers.image.base.name=${{ matrix.base_image }}
          dev.dotfiles.platform=${{ matrix.platform }}
          dev.dotfiles.tools=git,zsh,tmux,neovim,stow,act
          dev.dotfiles.languages=golang,python,nodejs,rust

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.dockerfile }}
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false

    - name: Generate artifact attestation
      if: github.event_name != 'pull_request'
      uses: actions/attest-build-provenance@v1
      with:
        subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.platform }}
        subject-digest: ${{ steps.build.outputs.digest }}
        push-to-registry: true

  # Job to create a summary of published images
  publish-summary:
    if: github.event_name != 'pull_request'
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - name: Create Deployment Summary
      run: |
        echo "## ðŸ“¦ Published Docker Images" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The following dotfiles development environment images have been published:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Image | Pull Command |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|--------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Ubuntu 22.04 | \`ghcr.io/${{ github.repository }}-ubuntu:latest\` | \`docker pull ghcr.io/${{ github.repository }}-ubuntu:latest\` |" >> $GITHUB_STEP_SUMMARY
        echo "| CentOS Stream 9 | \`ghcr.io/${{ github.repository }}-centos:latest\` | \`docker pull ghcr.io/${{ github.repository }}-centos:latest\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Alpine Linux | \`ghcr.io/${{ github.repository }}-alpine:latest\` | \`docker pull ghcr.io/${{ github.repository }}-alpine:latest\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ› ï¸ What's Included" >> $GITHUB_STEP_SUMMARY
        echo "Each image includes a complete development environment with:" >> $GITHUB_STEP_SUMMARY
        echo "- **Core Tools**: git, zsh, tmux, neovim, stow" >> $GITHUB_STEP_SUMMARY
        echo "- **Languages**: Go, Python, Node.js, Rust" >> $GITHUB_STEP_SUMMARY
        echo "- **CLI Tools**: fd, ripgrep, fzf, lazygit, act" >> $GITHUB_STEP_SUMMARY
        echo "- **User**: \`testuser\` with zsh as default shell" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Run Ubuntu environment" >> $GITHUB_STEP_SUMMARY
        echo "docker run -it --rm ghcr.io/${{ github.repository }}-ubuntu:latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Run with your dotfiles mounted" >> $GITHUB_STEP_SUMMARY
        echo "docker run -it --rm -v \$(pwd):/home/testuser/dotfiles ghcr.io/${{ github.repository }}-ubuntu:latest" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Image Tags" >> $GITHUB_STEP_SUMMARY
        echo "- \`latest\`: Latest stable build from main branch" >> $GITHUB_STEP_SUMMARY
        echo "- \`develop\`: Latest development build" >> $GITHUB_STEP_SUMMARY
        echo "- \`v*\`: Tagged releases" >> $GITHUB_STEP_SUMMARY
        echo "- \`<branch>-<sha>\`: Branch-specific builds" >> $GITHUB_STEP_SUMMARY

  # Security scanning for published images  
  security-scan:
    if: github.event_name != 'pull_request'
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    strategy:
      matrix:
        platform: [ubuntu, centos, alpine]
    steps:
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ghcr.io/${{ github.repository }}-${{ matrix.platform }}:latest
        format: sarif
        output: trivy-results-${{ matrix.platform }}.sarif

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-results-${{ matrix.platform }}.sarif
        category: trivy-${{ matrix.platform }}